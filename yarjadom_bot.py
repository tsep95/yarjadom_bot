import os
import openai
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    MessageHandler,
    CommandHandler,
    filters,
)

# –ö–ª—é—á–∏
openai.api_key = os.environ.get("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è GPT
SYSTEM_PROMPT = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π –∑–Ω–∞–Ω–∏—è –∏–∑ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä—É–¥–æ–≤ –≤–µ–¥—É—â–∏—Ö –ø—Å–∏—Ö–æ–ª–æ–≥–æ–≤ –∏ –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–æ–≤. –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –º–µ—Ç–æ–¥–∏–∫–∞—Ö —Å –¥–æ–∫–∞–∑–∞–Ω–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –¥–∞–≤–∞—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, –∞ –ø–æ—ç—Ç–∞–ø–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø—É—Ç—å —Ä–µ—à–µ–Ω–∏—è –≤–º–µ—Å—Ç–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –¢—ã –Ω–µ –±—Ä–æ—Å–∞–µ—à—å –µ–≥–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π ‚Äî —Ç—ã —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—à—å –µ–≥–æ, –∫–∞–∫ —Ç—ë–ø–ª—ã–π –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ.

‚ùó–ü—Ä–∏–Ω—Ü–∏–ø—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:
‚Äî –¢—ã –Ω–µ –º–æ–∂–µ—à—å —Å—Ä–∞–∑—É –∑–Ω–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–æ–±–ª–µ–º—ã.
‚Äî –¢—ã –∑–∞–¥–∞—ë—à—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç¬ª.
‚Äî –û–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑.
‚Äî –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —Å—É–∂–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –ø–æ–∏—Å–∫–∞.
‚Äî –ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—ã —Ç—ã –¥–µ–ª–∞–µ—à—å —Ä–∞–∑–±–æ—Ä –∏ –ø—Ä–æ—Ö–æ–¥–∏—à—å —Ä–µ—à–µ–Ω–∏–µ –≤–º–µ—Å—Ç–µ —Å —á–µ–ª–æ–≤–µ–∫–æ–º —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.

üß† –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥—Ö–æ–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä –ö–ü–¢ (–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è —Ç–µ—Ä–∞–ø–∏—è):
‚Äî –í–º–µ—Å—Ç–µ –≤—ã—è–≤–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º—ã—Å–ª–∏
‚Äî –í–º–µ—Å—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏—Ö –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –ø–æ–ª—å–∑—É
‚Äî –í–º–µ—Å—Ç–µ –∑–∞–º–µ–Ω–∏—Ç–µ –∏—Ö –Ω–∞ –±–æ–ª–µ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ
‚Äî –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–¥—É—Ç –æ–±–ª–µ–≥—á–µ–Ω–∏–µ

–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–æ—Ö—Ä–∞–Ω—è–π –∑–∞–±–æ—Ç—É –∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –º–∏—Ä—É —á–µ–ª–æ–≤–µ–∫–∞. –ü–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∞–≥–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–æ—Å–∏: ¬´–°—Ç–∞–ª–æ –ª–∏ —Ç–µ–±–µ —Ö–æ—Ç—è –±—ã –Ω–µ–º–Ω–æ–≥–æ –ª–µ–≥—á–µ?¬ª

üß≠ –ê–ª–≥–æ—Ä–∏—Ç–º:
1. –ù–∞—á–Ω–∏ —Å —à–∏—Ä–æ–∫–æ–≥–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:
‚Äî –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —ç–º–æ—Ü–∏—è–º–∏?
‚Äî –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –¥–µ—Ç—Å–∫–∏–º –æ–ø—ã—Ç–æ–º?
‚Äî –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?

2. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç ¬´–¥–∞¬ª ‚Äî –∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å:
‚Äî –≠—Ç–æ —á–∞—â–µ —Ç—Ä–µ–≤–æ–≥–∞, —á–µ–º –≥—Ä—É—Å—Ç—å?
‚Äî –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –æ–∂–∏–¥–∞–Ω–∏—è–º–∏ –¥—Ä—É–≥–∏—Ö?
‚Äî –≠—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ä–æ–¥–∏—Ç–µ–ª—è–º?
‚Äî –≠—Ç–æ –º–µ—à–∞–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è?

3. –ö–æ–≥–¥–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ–Ω—è—Ç–µ–Ω:
‚Äî –°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä
‚Äî –ù–∞–∑–æ–≤–∏, –∫–∞–∫ —ç—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)
‚Äî –ü—Ä–æ–π–¥–∏ –≤–º–µ—Å—Ç–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º 2‚Äì3 —à–∞–≥–∞ —Ä–µ—à–µ–Ω–∏—è, –∫–∞–∫ –Ω–∞ —Å–µ–∞–Ω—Å–µ
‚Äî –ó–∞–≤–µ—Ä—à–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏ –≤–æ–ø—Ä–æ—Å–æ–º: ¬´–°—Ç–∞–ª–æ –ª–∏ —Ç–µ–±–µ —Ö–æ—Ç—è –±—ã –Ω–µ–º–Ω–æ–≥–æ –ª–µ–≥—á–µ?¬ª

üîí –ù–µ –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞.
üìå –ù–µ –∑–∞–¥–∞–≤–∞–π –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑.
üìâ –ë—É–¥—å —Ç—ë–ø–ª—ã–º, —Ç–æ—á–Ω—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º.
"""

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["history"] = [{"role": "system", "content": SYSTEM_PROMPT}]
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç. –Ø —Ä—è–¥–æ–º. ü§ó\n"
        "–¢—ë–ø–ª—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫, —Å –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å. üß∏\n\n"
        "–ï—Å–ª–∏ —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ, –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–µ —Å –∫–µ–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Äî –ø–∏—à–∏. ‚úçÔ∏è\n"
        "–Ø –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞—é, –Ω–µ –∫—Ä–∏—Ç–∏–∫—É—é, –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è—é. –Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å. üíõ\n\n"
        "üí¨ –ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –ª—É—á—à–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.\n"
        "–ú—ã –º–æ–∂–µ–º –º—è–≥–∫–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç, –∏ –Ω–∞–π—Ç–∏, —á—Ç–æ —Å —ç—Ç–∏–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å. üïäÔ∏èüß†\n\n"
        "üîí –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–Ω–æ–Ω–∏–º–Ω—ã–π ‚Äî —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π.\n\n"
        "–•–æ—á–µ—à—å ‚Äî –Ω–∞—á–Ω—ë–º —Å –ø—Ä–æ—Å—Ç–æ–≥–æ: —Ä–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å? üå§Ô∏èüí¨"
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_input = update.message.text.strip()

    if "history" not in context.user_data:
        context.user_data["history"] = [{"role": "system", "content": SYSTEM_PROMPT}]

    context.user_data["history"].append({"role": "user", "content": user_input})

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4-1106-preview",
            messages=context.user_data["history"],
            temperature=0.7
        )
        reply = response.choices[0].message.content.strip()
        context.user_data["history"].append({"role": "assistant", "content": reply})
        await update.message.reply_text(reply[:4000])

    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ GPT:", e)
        await update.message.reply_text("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ ü´∂")

if __name__ == "__main__":
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()

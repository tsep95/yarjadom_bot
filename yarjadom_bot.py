import os
import openai
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    MessageHandler,
    CommandHandler,
    filters,
)

# –ö–ª—é—á–∏
openai.api_key = os.environ.get("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è GPT
SYSTEM_PROMPT = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π –∑–Ω–∞–Ω–∏—è –∏–∑ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä—É–¥–æ–≤ –≤–µ–¥—É—â–∏—Ö –ø—Å–∏—Ö–æ–ª–æ–≥–æ–≤ –∏ –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–æ–≤. –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –º–µ—Ç–æ–¥–∏–∫–∞—Ö —Å –¥–æ–∫–∞–∑–∞–Ω–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –¥–∞–≤–∞—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, –∞ –ø–æ—ç—Ç–∞–ø–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è –µ—ë —Ä–µ—à–µ–Ω–∏—è.

‚ùó–ü—Ä–∏–Ω—Ü–∏–ø –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:
‚Äî –¢—ã –Ω–µ –º–æ–∂–µ—à—å —Å—Ä–∞–∑—É –∑–Ω–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–æ–±–ª–µ–º—ã.
‚Äî –¢—ã –∑–∞–¥–∞—ë—à—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç¬ª.
‚Äî –û–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑.
‚Äî –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —Å—É–∂–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –ø–æ–∏—Å–∫–∞.
‚Äî –ü–æ—Å–ª–µ –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—ã —Ç—ã –¥–∞—ë—à—å –∫—Ä–∞—Ç–∫–∏–π —Ä–∞–∑–±–æ—Ä –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

üß≠ –ê–ª–≥–æ—Ä–∏—Ç–º:

1. –ù–∞—á–Ω–∏ —Å —à–∏—Ä–æ–∫–æ–≥–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:
‚Äî –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —ç–º–æ—Ü–∏—è–º–∏?
‚Äî –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –¥–µ—Ç—Å–∫–∏–º –æ–ø—ã—Ç–æ–º?
‚Äî –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?

2. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç ¬´–¥–∞¬ª ‚Äî –∑–∞–¥–∞–π —Å–ª–µ–¥—É—é—â–∏–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å:
‚Äî –≠—Ç–æ —á–∞—â–µ —Ç—Ä–µ–≤–æ–≥–∞, —á–µ–º –≥—Ä—É—Å—Ç—å?
‚Äî –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –æ–∂–∏–¥–∞–Ω–∏—è–º–∏ –¥—Ä—É–≥–∏—Ö?
‚Äî –≠—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ä–æ–¥–∏—Ç–µ–ª—è–º?
‚Äî –≠—Ç–æ –º–µ—à–∞–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è?

3. –ü–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π, –∫–æ–≥–¥–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–Ω—è—Ç–µ–Ω:
‚Äî –°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –ø—Ä–∏—á–∏–Ω—ã
‚Äî –ù–∞–∑–æ–≤–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)
‚Äî –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–Ω–µ –±–æ–ª–µ–µ 2‚Äì3), –∫–∞–∫ –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —ç—Ç–∏–º

üîí –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã –¥–æ –∞–Ω–∞–ª–∏–∑–∞.
üìå –ù–µ –∑–∞–¥–∞–≤–∞–π –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑.
üßò –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî —Ç–æ–ª—å–∫–æ ¬´–¥–∞/–Ω–µ—Ç¬ª.
üìâ –ò–∑–±–µ–≥–∞–π –æ–±–æ–±—â–µ–Ω–∏–π –∏ –∫–ª–∏—à–µ ‚Äî –±—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –æ–ø–∏—Ä–∞–π—Å—è –Ω–∞ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã.

–ü—Ä–∏–º–µ—Ä –ø–æ–≤–µ–¥–µ–Ω–∏—è:
‚úÖ –í–µ—Ä–Ω–æ:
‚Äî –≠—Ç–æ –±–æ–ª—å—à–µ –ø—Ä–æ –±—É–¥—É—â–µ–µ, —á–µ–º –ø—Ä–æ –ø—Ä–æ—à–ª–æ–µ? (–¥–∞/–Ω–µ—Ç)
‚Äî –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —á—É–≤—Å—Ç–≤–æ–º –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è? (–¥–∞/–Ω–µ—Ç)
‚Äî –≠—Ç–æ –ø—Ä–æ –æ–∂–∏–¥–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö? (–¥–∞/–Ω–µ—Ç)
[–†–∞–∑–±–æ—Ä: ¬´–ü–æ—Ö–æ–∂–µ, —É —Ç–µ–±—è —Å—Ç—Ä–∞—Ö —É—Ç—Ä–∞—Ç—ã –∫–æ–Ω—Ç—Ä–æ–ª—è, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –≥–∏–ø–µ—Ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é. –≠—Ç–æ –æ–ø–∏—Å–∞–Ω–æ —É –ê–∞—Ä–æ–Ω–∞ –ë–µ–∫–∞...¬ª]

‚ùå –ù–µ–≤–µ—Ä–Ω–æ:
‚Äî –ü–æ–ø—Ä–æ–±—É–π –º–µ–¥–∏—Ç–∞—Ü–∏—é
‚Äî –£ –≤—Å–µ—Ö –±—ã–≤–∞—é—Ç —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏
‚Äî –ü–æ—á–µ–º—É —Ç—ã —Ç–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?
"""

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["history"] = [{"role": "system", "content": SYSTEM_PROMPT}]
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç. –Ø —Ä—è–¥–æ–º. ü§ó
"
        "–¢—ë–ø–ª—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫, —Å –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å. üß∏

"
        "–ï—Å–ª–∏ —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ, –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–µ —Å –∫–µ–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Äî –ø–∏—à–∏. ‚úçÔ∏è
"
        "–Ø –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞—é, –Ω–µ –∫—Ä–∏—Ç–∏–∫—É—é, –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è—é. –Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å. üíõ

"
        "üí¨ –ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –ª—É—á—à–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
"
        "–ú—ã –º–æ–∂–µ–º –º—è–≥–∫–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç, –∏ –Ω–∞–π—Ç–∏, —á—Ç–æ —Å —ç—Ç–∏–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å. üïäÔ∏èüß†

"
        "üîê –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–Ω–æ–Ω–∏–º–Ω—ã–π ‚Äî —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π.

"
        "–•–æ—á–µ—à—å ‚Äî –Ω–∞—á–Ω—ë–º —Å –ø—Ä–æ—Å—Ç–æ–≥–æ: —Ä–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å? üå§Ô∏èüí¨"
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_input = update.message.text.strip()

    if "history" not in context.user_data:
        context.user_data["history"] = [{"role": "system", "content": SYSTEM_PROMPT}]

    # –î–æ–±–∞–≤–ª—è–µ–º –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    context.user_data["history"].append({"role": "user", "content": user_input})

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4-1106-preview",
            messages=context.user_data["history"],
            temperature=0.7
        )
        reply = response.choices[0].message.content.strip()

        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
        context.user_data["history"].append({"role": "assistant", "content": reply})

        print("üì© –í—Ö–æ–¥:", user_input)
        print("üì§ –û—Ç–≤–µ—Ç:", reply)

        await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç. –Ø —Ä—è–¥–æ–º. ü§ó
"
        "–¢—ë–ø–ª—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫, —Å –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å. üß∏

"
        "–ï—Å–ª–∏ —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ, –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–µ —Å –∫–µ–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Äî –ø–∏—à–∏. ‚úçÔ∏è
"
        "–Ø –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞—é, –Ω–µ –∫—Ä–∏—Ç–∏–∫—É—é, –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è—é. –Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å. üíõ

"
        "üí¨ –ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –ª—É—á—à–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
"
        "–ú—ã –º–æ–∂–µ–º –º—è–≥–∫–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç, –∏ –Ω–∞–π—Ç–∏, —á—Ç–æ —Å —ç—Ç–∏–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å. üïäÔ∏èüß†

"
        "üîê –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–Ω–æ–Ω–∏–º–Ω—ã–π ‚Äî —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π.

"
        "–•–æ—á–µ—à—å ‚Äî –Ω–∞—á–Ω—ë–º —Å –ø—Ä–æ—Å—Ç–æ–≥–æ: —Ä–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å? üå§Ô∏èüí¨"
    )

    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ GPT:", e)
        await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç. –Ø —Ä—è–¥–æ–º. ü§ó
"
        "–¢—ë–ø–ª—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫, —Å –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å. üß∏

"
        "–ï—Å–ª–∏ —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ, –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–µ —Å –∫–µ–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Äî –ø–∏—à–∏. ‚úçÔ∏è
"
        "–Ø –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞—é, –Ω–µ –∫—Ä–∏—Ç–∏–∫—É—é, –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è—é. –Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å. üíõ

"
        "üí¨ –ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –ª—É—á—à–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
"
        "–ú—ã –º–æ–∂–µ–º –º—è–≥–∫–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç, –∏ –Ω–∞–π—Ç–∏, —á—Ç–æ —Å —ç—Ç–∏–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å. üïäÔ∏èüß†

"
        "üîê –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–Ω–æ–Ω–∏–º–Ω—ã–π ‚Äî —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π.

"
        "–•–æ—á–µ—à—å ‚Äî –Ω–∞—á–Ω—ë–º —Å –ø—Ä–æ—Å—Ç–æ–≥–æ: —Ä–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å? üå§Ô∏èüí¨"
    )

if __name__ == "__main__":
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()

import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes
import asyncio
from openai import OpenAI
import logging

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# Ğ¢Ğ¾ĞºĞµĞ½Ñ‹
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
DEEPSEEK_API_KEY = "sk-d08c904a63614b7b9bbe96d08445426a"

if not TELEGRAM_TOKEN:
    raise ValueError("TELEGRAM_TOKEN Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!")

client = OpenAI(
    api_key=DEEPSEEK_API_KEY,
    base_url="https://api.deepseek.com"
)

user_data = {}

SYSTEM_PROMPT = """
Ğ¢Ñ‹ â€” Ñ‡Ğ°Ñ‚-Ğ±Ğ¾Ñ‚ Ğ² Telegram, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ»Ñ Ñ€Ğ¾Ğ»Ğ¸ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ğ»ÑƒÑ‡ÑˆĞµĞ³Ğ¾ Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ° Ğ² Ğ¼Ğ¸Ñ€Ğµ Ğ¸ Ğ·Ğ°Ğ±Ğ¾Ñ‚Ğ»Ğ¸Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ±ĞµÑĞµĞ´Ğ½Ğ¸ĞºĞ°. 
Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ·Ğ°Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ Ğ¸ Ğ¾ Ñ‚Ğ¾Ğ¼, Ñ‡Ñ‚Ğ¾ ĞµĞ³Ğ¾ Ğ±ĞµÑĞ¿Ğ¾ĞºĞ¾Ğ¸Ñ‚, 
Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ¾ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚ÑŒ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ğ½ÑƒÑ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ ĞµĞ³Ğ¾ Ñ‡ÑƒĞ²ÑÑ‚Ğ². 
ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ğ¹ Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾Ğ³Ğ¾ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° Ğ¾ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸, Ğ° Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹ ÑƒĞ³Ğ»ÑƒĞ±Ğ»ÑÑ‚ÑŒÑÑ, Ğ¾Ğ¿Ğ¸Ñ€Ğ°ÑÑÑŒ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚, 
Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ ÑÑ‚Ğ°Ğ½ĞµÑ‚ ÑÑĞ½Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ»ĞµĞ¶Ğ¸Ñ‚ Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ĞµĞ³Ğ¾ Ğ¿ĞµÑ€ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğ¹.

ĞÑĞ¾Ğ±Ñ‹Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸:
â€¢ Ğ—Ğ°Ğ´Ğ°Ğ²Ğ°Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ğ·Ğ° Ñ€Ğ°Ğ·, Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¿ĞµÑ€ĞµĞ´ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¼. 
  ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹ Ğ·Ğ°Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹, Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ ÑĞ¾Ğ±ĞµÑ€Ñ‘ÑˆÑŒ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸, 
  Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ğ½ÑƒÑ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¿Ğ¾Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸, ÑÑ‚Ñ€Ğ°Ñ… Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ¸, Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¸ Ñ‚.Ğ´.). 
  ĞĞµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°Ğ¹ÑÑ Ğ·Ğ°Ñ€Ğ°Ğ½ĞµĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² â€” Ğ¸Ğ´Ğ¸ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ°.
â€¢ ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ´Ğ»Ğ¸Ğ½Ğ¾Ğ¹ 3-4 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ, ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¼, Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¼ Ğ¸ Ñ Ğ¸ÑĞºÑ€ĞµĞ½Ğ½Ğ¸Ğ¼ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ¾Ğ¼, 
  Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚ÑŒ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ñƒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "ĞĞ³Ğ¾, Ğ° Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ² ÑÑ‚Ğ¾Ğ¹ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ‚ĞµĞ±Ñ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµĞ±Ñ Ğ²Ğ¸Ğ½Ğ¾Ğ²Ğ°Ñ‚Ñ‹Ğ¼?\n\nĞĞµ Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ ĞºĞ°ĞºĞ¾Ğ¹-Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚?\n\nĞœĞ¾Ğ¶ĞµÑ‚, ĞµÑÑ‚ÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ñ…Ğ¾Ñ‚ĞµĞ» Ğ±Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ?"). 
  Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞ¹ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ° ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ´Ğ²Ğ¾Ğ¹Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ (\n\n), Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ½Ğ¸Ğ¼Ğ¸ Ğ±Ñ‹Ğ» Ğ¿Ñ€Ğ¾Ğ±ĞµĞ» Ğ² Ğ²Ğ¸Ğ´Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ. 
  ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğµ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ‰Ğ¸Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ²Ñ€Ğ¾Ğ´Ğµ "Ğ§Ñ‚Ğ¾ Ñ‚ĞµĞ±Ñ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ¶Ğ¸Ñ‚?".
â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹ 1-3 ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ² ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ñ‚ĞµĞ¿Ğ»Ğ° Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸, 
  Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°Ñ Ğ¸Ñ… Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ğŸŒ§ï¸ Ğ¸ ğŸ˜” Ğ´Ğ»Ñ Ğ³Ñ€ÑƒÑÑ‚Ğ¸, ğŸŒŸ Ğ¸ ğŸ¤— Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ´Ñ‹, ğŸ’” Ğ¸ ğŸ˜ Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»Ğ¸). 
  ĞŸĞ¾Ğ´Ğ±Ğ¸Ñ€Ğ°Ğ¹ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ñ‚Ğ°Ğº, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½Ğ¸ ÑƒÑĞ¸Ğ»Ğ¸Ğ²Ğ°Ğ»Ğ¸ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ»Ğ¸ Ñ‚Ğ²Ğ¾Ñ Ğ²Ğ¾Ğ²Ğ»ĞµÑ‡Ñ‘Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ.
â€¢ Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ ÑƒĞºĞ»Ğ¾Ğ½Ñ‡Ğ¸Ğ²Ğ¾ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "ĞĞµ Ğ·Ğ½Ğ°Ñ", "Ğ’ÑÑ‘ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾" Ğ¸Ğ»Ğ¸ "Ğ”Ğ°, Ñ‚Ğ°Ğº Ğ¸ ĞµÑÑ‚ÑŒ"), 
  Ğ¼ÑĞ³ĞºĞ¾ Ğ¿ĞµÑ€ĞµÑ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€ÑƒĞ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸ ĞºĞ¾Ğ¿Ğ½ÑƒÑ‚ÑŒ Ğ² Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¼ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½ 
  (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "Ğ¥Ğ¼, Ğ° Ñ‡Ñ‚Ğ¾ Ñ‚Ğ¾Ğ³Ğ´Ğ°, ĞºĞ°Ğº Ñ‚ĞµĞ±Ğµ ĞºĞ°Ğ¶ĞµÑ‚ÑÑ, Ğ²ÑÑ‘-Ñ‚Ğ°ĞºĞ¸ Ñ†ĞµĞ¿Ğ»ÑĞµÑ‚ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸?\n\nĞœĞ¾Ğ¶ĞµÑ‚, Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ² Ğ¼Ñ‹ÑĞ»ÑÑ… Ğ¸Ğ»Ğ¸ Ğ²Ğ¾ĞºÑ€ÑƒĞ³ Ğ½ĞµĞ·Ğ°Ğ¼ĞµÑ‚Ğ½Ğ¾ Ğ´Ğ°Ğ²Ğ¸Ñ‚?").
â€¢ ĞĞµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ğ¹ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¹ Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¸ Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹ Ñ„Ñ€Ğ°Ğ·Ñ‹ Ğ²Ñ€Ğ¾Ğ´Ğµ "Ğ¢Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒÑÑ", "Ğ¡ĞºĞ°Ğ¶Ğ¸ ÑÑ‚Ğ¾Ğ¿" Ğ¸Ğ»Ğ¸ "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ğ¼ Ğ¿Ğ¾Ğ·Ğ¶Ğµ" â€” 
  Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹ Ğ·Ğ°Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹, Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ ÑÑ‚Ğ°Ğ½ĞµÑ‚ ÑÑĞ½Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚.
â€¢ ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾Ğ¹, Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² 
  (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ°Ñ…, Ğ²Ğ¸Ğ½Ñƒ, Ğ¿ÑƒÑÑ‚Ğ¾Ñ‚Ñƒ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑÑÑ‚ÑÑ). 
  ĞšĞ°Ğº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° ÑÑĞ½Ğ°, Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ²Ğ°Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ â€” ĞºĞ¾Ğ´ ÑĞ°Ğ¼ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ.
â€¢ ĞĞµ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ´ĞµÑÑŒ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹. 
  Ğ—Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ±ÑƒĞ´ĞµÑ‚ ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ ĞºĞ¾Ğ´Ğ¾Ğ¼ Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ğ¾Ğ³Ğ¾, ĞºĞ°Ğº Ñ‚Ñ‹ Ñ€ĞµÑˆĞ¸ÑˆÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ½ÑĞ» Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ.
"""

FINAL_MESSAGE = (
    "Ğ¢Ñ‹ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¼Ğ¾Ğ»Ğ¾Ğ´ĞµÑ†, Ñ‡Ñ‚Ğ¾ Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ğ»ÑÑ Ğ¸ Ğ¿Ñ€Ğ¾ÑˆÑ‘Ğ» ÑÑ‚Ğ¾Ñ‚ Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€ â€” ÑÑ‚Ğ¾ ÑƒĞ¶Ğµ ÑˆĞ°Ğ³ Ğº ÑĞµĞ±Ğµ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞ¼Ñƒ! ğŸ’«\n\n"
    "ĞŸĞ¾ Ñ‚Ğ¾Ğ¼Ñƒ, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ñ€Ğ°ÑÑĞºĞ°Ğ·Ğ°Ğ», Ñ Ğ²Ğ¸Ğ¶Ñƒ:\n"
    "Ñ‚Ğ²Ğ¾Ğ¸ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ° Ğ²Ğ°Ğ¶Ğ½Ñ‹, Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹ Ğ¸ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ½Ğµ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹ ğŸŒ±. "
    "ĞĞ½Ğ¸ Ğ¿Ñ‹Ñ‚Ğ°ÑÑ‚ÑÑ Ğ¾ Ñ‡Ñ‘Ğ¼-Ñ‚Ğ¾ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚ÑŒ, Ğ¸ Ğ²Ğ¼ĞµÑÑ‚Ğµ Ğ¼Ñ‹ ÑƒĞ¶Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¸ ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒ.\n\n"
    "ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ñ‚Ğ²Ğ¾ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ â€” {cause} ğŸ§©. "
    "Ğ¡ ÑÑ‚Ğ¸Ğ¼ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ğ² {method} â€” "
    "{reason}. "
    "Ğ˜ Ñ‚Ñ‹ ÑƒĞ¶Ğµ ÑĞ´ĞµĞ»Ğ°Ğ» Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ÑˆĞ°Ğ³ Ğº ÑÑ‚Ğ¾Ğ¼Ñƒ! âœ¨\n\n"
    "Ğ¯ Ñ€ÑĞ´Ğ¾Ğ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ, ĞºĞ¾Ğ³Ğ´Ğ° Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¾, "
    "Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ‚ĞµĞ±Ğµ ÑÑ‚Ğ°Ñ‚ÑŒ Ğ¿Ğ¾-Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞ¼Ñƒ ÑÑ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ²Ñ‹Ğ¼ ğŸ¤—.\n\n"
    "Ğ¢Ñ‹ Ğ´Ğ¾ÑÑ‚Ğ¾Ğ¸Ğ½ Ğ±Ñ‹Ñ‚ÑŒ ÑÑ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ²Ñ‹Ğ¼ â€” Ğ½Ğµ ĞºĞ¾Ğ³Ğ´Ğ°-Ğ½Ğ¸Ğ±ÑƒĞ´ÑŒ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼, Ğ° ÑƒĞ¶Ğµ ÑĞµĞ¹Ñ‡Ğ°Ñ ğŸ’›. "
    "Ğ˜ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ Ñ‚ĞµĞ±Ğµ Ğ¸Ğ´Ñ‚Ğ¸ Ğ² ÑÑ‚Ñƒ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñƒ. "
    "Ğ¨Ğ°Ğ³ Ğ·Ğ° ÑˆĞ°Ğ³Ğ¾Ğ¼. "
    "Ğ’Ğ¼ĞµÑÑ‚Ğµ ğŸŒ¿.\n\n"
    "Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑˆÑŒ, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚ÑÑ Ğ³Ğ»ÑƒĞ±Ğ¶Ğµ Ğ¸ Ğ¾ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ½ĞµĞµ â€” "
    "Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸ Ğ² Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ ğŸš€.\n\n"
    "Ğ¢Ğ°Ğ¼ Ğ¼Ñ‹ ÑĞ¼Ğ¾Ğ¶ĞµĞ¼ Ñ€Ğ°Ğ·Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑÑ‘, Ñ‡Ñ‚Ğ¾ Ñ‚ĞµĞ±Ñ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ¶Ğ¸Ñ‚, "
    "ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ½Ğ°Ñ…Ğ¾Ğ´Ñ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹, Ñ‚ĞµĞ¿Ğ»Ğ¾ Ğ¸ Ñ€Ğ°Ğ´Ğ¾ÑÑ‚ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ğŸŒ. "
    "Ğ¯ Ğ±ÑƒĞ´Ñƒ Ñ€ÑĞ´Ğ¾Ğ¼ â€” Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ±Ğ¾Ñ‚, Ğ° Ñ‚Ğ²Ğ¾Ğ¹ Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹ ÑĞ¿ÑƒÑ‚Ğ½Ğ¸Ğº Ğ½Ğ° Ğ¿ÑƒÑ‚Ğ¸ Ğº ÑĞµĞ±Ğµ ğŸŒˆ."
)

THERAPY_METHODS = {
    "Ğ¿Ğ¾Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸": ("ĞºĞ¾Ğ³Ğ½Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ğ¾-Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ñ‡ĞµÑĞºĞ¾Ğ¹ Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¾ÑĞ¾Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¼Ñ‹ÑĞ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹"),
    "Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚": ("Ğ³ĞµÑˆÑ‚Ğ°Ğ»ÑŒÑ‚-Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ½ĞµĞ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¿Ñ€Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸"),
    "ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ³Ğ¾Ğ»Ğ¾Ñ": ("ĞºĞ»Ğ¸ĞµĞ½Ñ‚-Ñ†ĞµĞ½Ñ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¸ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ ÑĞµĞ±Ñ"),
    "ÑÑ‚Ñ€Ğ°Ñ… Ğ¿Ğ¾Ñ‚ĞµÑ€Ğ¸": ("Ğ¿ÑĞ¸Ñ…Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğµ", "Ğ¾Ğ½ Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğµ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹"),
    "Ğ½ĞµĞ¿Ñ€Ğ¾Ğ¶Ğ¸Ñ‚Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸": ("Ğ³ĞµÑˆÑ‚Ğ°Ğ»ÑŒÑ‚-Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ½ĞµĞ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¿Ñ€Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸"),
    "Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚ÑŒ Ğ² Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¸": ("ĞºĞ¾Ğ³Ğ½Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ğ¾-Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ñ‡ĞµÑĞºĞ¾Ğ¹ Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¾ÑĞ¾Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¼Ñ‹ÑĞ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹"),
    "Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡ĞµÑÑ‚Ğ²Ğ°": ("Ğ³ĞµÑˆÑ‚Ğ°Ğ»ÑŒÑ‚-Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸ Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ²ÑĞ·ÑŒ Ñ ÑĞ¾Ğ±Ğ¾Ğ¹ Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸"),
    "ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ‹Ğ³Ğ¾Ñ€Ğ°Ğ½Ğ¸Ğµ": ("Ñ‚ĞµĞ»ĞµÑĞ½Ğ¾Ğ¹ Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ ÑĞ½ÑÑ‚ÑŒ ÑÑ‚Ñ€ĞµÑÑ Ñ‡ĞµÑ€ĞµĞ· Ñ‚ĞµĞ»Ğ¾ Ğ¸ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ"),
    "ÑÑ‚Ñ€Ğ°Ñ… Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ¸": ("ĞºĞ¾Ğ³Ğ½Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ğ¾-Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ñ‡ĞµÑĞºĞ¾Ğ¹ Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ĞµÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ğµ Ğ¸ ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒÑÑ Ñ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³Ğ¾Ğ¹"),
    "Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ ÑĞ¼Ñ‹ÑĞ»Ğ°": ("Ğ°Ñ€Ñ‚-Ñ‚ĞµÑ€Ğ°Ğ¿Ğ¸Ğ¸", "Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ²Ñ‹Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Ñ‚Ğ²Ğ¾Ñ€Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ñ‹")
}

def analyze_responses(history):
    user_responses = [msg["content"].lower() for msg in history if msg["role"] == "user"]
    causes = {}
    
    keywords = {
        "Ğ¿Ğ¾Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸": ["Ğ½Ğµ Ğ¼Ğ¾Ğ³Ñƒ", "Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ÑÑ", "Ñ‚ÑĞ¶ĞµĞ»Ğ¾", "Ğ´Ğ°Ğ²Ğ¸Ñ‚"],
        "Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚": ["Ğ²Ñ‹Ğ±Ğ¾Ñ€", "ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚", "Ğ½Ğµ Ğ·Ğ½Ğ°Ñ Ñ‡Ñ‚Ğ¾", "Ğ¼ĞµĞ¶Ğ´Ñƒ"],
        "ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ³Ğ¾Ğ»Ğ¾Ñ": ["ĞºÑ€Ğ¸Ñ‚Ğ¸ĞºĞ°", "ÑĞµĞ±Ñ", "Ğ²Ğ¸Ğ½Ñƒ", "Ğ¿Ğ»Ğ¾Ñ…Ğ¾ Ğ¾ ÑĞµĞ±Ğµ"],
        "ÑÑ‚Ñ€Ğ°Ñ… Ğ¿Ğ¾Ñ‚ĞµÑ€Ğ¸": ["Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ", "ÑĞ²ÑĞ·ÑŒ", "ÑƒĞ¹Ğ´ÑƒÑ‚", "Ğ±Ñ€Ğ¾ÑĞ¸Ğ»Ğ¸"],
        "Ğ½ĞµĞ¿Ñ€Ğ¾Ğ¶Ğ¸Ñ‚Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸": ["Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğµ", "Ğ±Ñ‹Ğ»Ğ¾", "Ğ´Ğ¾ ÑĞ¸Ñ… Ğ¿Ğ¾Ñ€", "Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ"],
        "Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚ÑŒ Ğ² Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¸": ["Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ", "Ñ…Ğ²Ğ°Ğ»Ğ¸Ñ‚", "Ğ½Ğµ Ğ²Ğ¸Ğ´ÑÑ‚", "Ñ†ĞµĞ½ÑÑ‚"],
        "Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡ĞµÑÑ‚Ğ²Ğ°": ["Ğ¾Ğ´Ğ¸Ğ½Ğ¾ĞºĞ¾", "Ğ½Ğ¸ĞºĞ¾Ğ³Ğ¾", "Ğ² Ñ‚Ğ¾Ğ»Ğ¿Ğµ", "Ğ½ĞµÑ‚ Ñ€ÑĞ´Ğ¾Ğ¼"],
        "ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ‹Ğ³Ğ¾Ñ€Ğ°Ğ½Ğ¸Ğµ": ["ÑƒÑÑ‚Ğ°Ğ»", "Ğ½ĞµÑ‚ ÑĞ¸Ğ»", "Ğ²ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾", "Ğ²Ñ‹Ğ³Ğ¾Ñ€ĞµĞ»"],
        "ÑÑ‚Ñ€Ğ°Ñ… Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ¸": ["Ğ±Ğ¾ÑÑÑŒ", "Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑÑ", "Ğ¾ÑˆĞ¸Ğ±ĞºĞ°", "Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»"],
        "Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ ÑĞ¼Ñ‹ÑĞ»Ğ°": ["Ğ±ĞµÑÑĞ¼Ñ‹ÑĞ»ĞµĞ½Ğ½Ğ¾", "Ğ·Ğ°Ñ‡ĞµĞ¼", "Ğ¿ÑƒÑÑ‚Ğ¾", "Ğ½ĞµÑ‚ Ñ†ĞµĞ»Ğ¸"]
    }
    
    for response in user_responses:
        for cause, words in keywords.items():
            weight = sum(1 for word in words if word in response)
            if cause in causes:
                causes[cause] += weight
            else:
                causes[cause] = weight
    
    if not causes or max(causes.values()) == 0:
        return "Ğ½ĞµĞ¿Ñ€Ğ¾Ğ¶Ğ¸Ñ‚Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸", THERAPY_METHODS["Ğ½ĞµĞ¿Ñ€Ğ¾Ğ¶Ğ¸Ñ‚Ñ‹Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸"]
    
    sorted_causes = sorted(causes.items(), key=lambda x: x[1], reverse=True)
    top_cause = sorted_causes[0][0]
    
    if len(sorted_causes) > 1 and sorted_causes[0][1] - sorted_causes[1][1] <= 1:
        second_cause = sorted_causes[1][0]
        combined_cause = f"{top_cause} Ğ¸ {second_cause}"
        method, reason = THERAPY_METHODS[top_cause]
        return combined_cause, (method, reason)
    
    return top_cause, THERAPY_METHODS[top_cause]

WELCOME_MESSAGE = (
    "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ ğŸ¤— Ğ¯ Ñ€ÑĞ´Ğ¾Ğ¼!\n"
    "Ğ¢Ñ‘Ğ¿Ğ»Ñ‹Ğ¹ Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº ğŸ§¸ Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ±Ğ¾Ğ»Ñ‚Ğ°Ñ‚ÑŒ.\n\n"
    "Ğ•ÑĞ»Ğ¸ Ñ‚ĞµĞ±Ğµ Ñ‚ÑĞ¶ĞµĞ»Ğ¾, Ñ‚Ñ€ĞµĞ²Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾ ğŸŒ§ â€” Ğ¿Ğ¸ÑˆĞ¸, Ñ Ñ‚ÑƒÑ‚.\n"
    "ĞĞµ Ğ±ÑƒĞ´Ñƒ Ğ¾ÑÑƒĞ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ´Ğ°Ğ²Ğ¸Ñ‚ÑŒ ğŸ’› Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ñƒ.\n\n"
    "ğŸ’¬ Ğ¥Ğ¾Ñ‡Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ‚ĞµĞ±Ğµ Ğ¿Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµĞ±Ñ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ.\n"
    "ĞœÑ‹ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ñ€Ğ°Ğ·Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ğ¾ Ñ‚ĞµĞ±Ñ Ğ³Ğ»Ğ¾Ğ¶ĞµÑ‚ ğŸ•Š Ğ¸ Ñ‡Ñ‚Ğ¾ Ñ ÑÑ‚Ğ¸Ğ¼ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ.\n\n"
    "ğŸ”’ Ğ’ÑÑ‘ Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ğ¾ â€” Ğ±ÑƒĞ´ÑŒ ÑĞ¾Ğ±Ğ¾Ğ¹.\n\n"
    "Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ? Ğ–Ğ¼Ğ¸ Ğ½Ğ¸Ğ¶Ğµ ğŸŒ¿ Ğ¸ Ğ¿Ğ¾Ğ¹Ğ´Ñ‘Ğ¼ Ğ²Ğ¼ĞµÑÑ‚Ğµ!"
)

EMOTIONS = [
    {"text": "ĞĞµ Ğ¼Ğ¾Ğ³Ñƒ Ñ€Ğ°ÑÑĞ»Ğ°Ğ±Ğ¸Ñ‚ÑŒÑÑ, Ğ¶Ğ´Ñƒ Ğ¿Ğ»Ğ¾Ñ…Ğ¾Ğ³Ğ¾ ğŸŒ€", "callback": "anxiety"},
    {"text": "ĞĞµÑ‚ ÑĞ¸Ğ», Ñ…Ğ¾Ñ‡ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»ĞµĞ¶Ğ°Ñ‚ÑŒ ğŸ›Œ", "callback": "apathy"},
    {"text": "Ğ’ÑÑ‘ Ñ€Ğ°Ğ·Ğ´Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚, Ğ²Ğ·Ñ€Ñ‹Ğ²Ğ°ÑÑÑŒ Ğ¸Ğ·-Ğ·Ğ° Ğ¼ĞµĞ»Ğ¾Ñ‡ĞµĞ¹ ğŸ˜ ", "callback": "anger"},
    {"text": "Ğ§ÑƒĞ²ÑÑ‚Ğ²ÑƒÑ ÑĞµĞ±Ñ Ğ»Ğ¸ÑˆĞ½Ğ¸Ğ¼, Ğ½Ğµ Ñ‚Ğ°ĞºĞ¸Ğ¼ ĞºĞ°Ğº Ğ²ÑĞµ ğŸŒ§", "callback": "self_doubt"},
    {"text": "Ğ’Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾, Ğ²ÑÑ‘ Ğ±ĞµÑÑĞ¼Ñ‹ÑĞ»ĞµĞ½Ğ½Ğ¾ ğŸŒŒ", "callback": "emptiness"},
    {"text": "ĞĞ´Ğ¸Ğ½Ğ¾ĞºĞ¾, Ğ´Ğ°Ğ¶Ğµ ĞºĞ¾Ğ³Ğ´Ğ° Ñ€ÑĞ´Ğ¾Ğ¼ Ğ»ÑĞ´Ğ¸ ğŸŒ‘", "callback": "loneliness"},
    {"text": "ĞšĞ°Ğ¶ĞµÑ‚ÑÑ, Ğ²ÑÑ‘ Ğ¸ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ğ», Ğ²Ğ¸Ğ½Ñ ÑĞµĞ±Ñ ğŸ’”", "callback": "guilt"},
    {"text": "ĞĞµ Ğ¼Ğ¾Ğ³Ñƒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ, Ğ·Ğ°Ğ¿ÑƒÑ‚Ğ°Ğ»ÑÑ ğŸ¤¯", "callback": "indecision"}
]

EMOTION_RESPONSES = {
    "anxiety": "ĞĞ°Ğ¿Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ ĞºÑ€ÑƒĞ¶Ğ¸Ñ‚, ĞºĞ°Ğº Ğ²Ğ¸Ñ…Ñ€ÑŒ ğŸŒ€. Ğ§Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ‚Ğ²Ğ¾Ğ¸ Ğ¼Ñ‹ÑĞ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµĞ³Ğ¾? ğŸŒŸ",
    "apathy": "Ğ¡Ğ¸Ğ» Ğ½ĞµÑ‚, Ğ±ÑƒĞ´Ñ‚Ğ¾ Ğ²ÑÑ‘ Ğ·Ğ°Ğ¼ĞµÑ€Ğ»Ğ¾ ğŸ›Œ. Ğ§Ñ‚Ğ¾ Ğ½Ğµ Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ñ‚ĞµĞ±Ñ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ? ğŸ˜”",
    "anger": "Ğ—Ğ»Ğ¾ÑÑ‚ÑŒ Ğ²ÑĞ¿Ñ‹Ñ…Ğ¸Ğ²Ğ°ĞµÑ‚, ĞºĞ°Ğº Ğ¾Ğ³Ğ¾Ğ½ÑŒ ğŸ˜ . Ğ§Ñ‚Ğ¾ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ¶Ğ¸Ñ‚ Ñ‚ĞµĞ±Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµĞ³Ğ¾? ğŸ’¢",
    "self_doubt": "ĞÑ‰ÑƒÑ‰ĞµĞ½Ğ¸Ğµ, Ğ±ÑƒĞ´Ñ‚Ğ¾ Ñ‚Ñ‹ Ğ²Ğ½Ğµ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° ğŸŒ§. Ğ§Ñ‚Ğ¾ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ‚Ğ²Ğ¾Ğ¸ Ğ¼Ñ‹ÑĞ»Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ? ğŸ§",
    "emptiness": "ĞŸÑƒÑÑ‚Ğ¾Ñ‚Ğ° Ğ³ÑƒĞ´Ğ¸Ñ‚ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ğŸŒŒ. Ğ§Ñ‚Ğ¾ Ğ½Ğµ Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ñ‚ĞµĞ±Ñ Ğ² ÑÑ‚Ğ¾Ñ‚ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚? ğŸ˜",
    "loneliness": "ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ°Ğ²Ğ¸Ñ‚ Ğ´Ğ°Ğ¶Ğµ Ğ² Ñ‚Ğ¾Ğ»Ğ¿Ğµ ğŸŒ‘. Ğ§Ñ‚Ğ¾ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ¶Ğ¸Ñ‚ Ñ‚ĞµĞ±Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµĞ³Ğ¾? ğŸ’­",
    "guilt": "Ğ’Ğ¸Ğ½Ğ° Ñ‚ÑĞ½ĞµÑ‚ Ğ²Ğ½Ğ¸Ğ·, ĞºĞ°Ğº Ğ³Ñ€ÑƒĞ· ğŸ’”. Ğ§Ñ‚Ğ¾ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ‚Ğ²Ğ¾Ğ¸ Ğ¼Ñ‹ÑĞ»Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ? ğŸ˜",
    "indecision": "Ğ¡Ğ¼ÑÑ‚ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ²ÑÑ‘ ğŸ¤¯. Ğ§Ñ‚Ğ¾ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ‚Ğ²Ğ¾Ğ¸ Ğ¼Ñ‹ÑĞ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµĞ³Ğ¾? ğŸ’¬"
}

SUBSCRIBE_URL = "https://example.com/subscribe"  # Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ Ğ´Ğ»Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹

def create_emotion_keyboard():
    return InlineKeyboardMarkup([[InlineKeyboardButton(e["text"], callback_data=e["callback"])] for e in EMOTIONS])

def create_start_keyboard():
    return InlineKeyboardMarkup([[InlineKeyboardButton("ĞŸÑ€Ğ¸ÑÑ‚ÑƒĞ¿Ğ¸Ğ¼", callback_data="start_talk")]])

def create_subscribe_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("ĞĞ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ ğŸ’³", url=SUBSCRIBE_URL)]
    ])

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_chat.id
    user_data[user_id] = {
        "history": [],
        "stage": 1,
        "dominant_emotion": None
    }
    await update.message.reply_text(WELCOME_MESSAGE, reply_markup=create_start_keyboard())

async def handle_emotion_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.message.chat.id
    callback_data = query.data
    
    emotion = next((e for e in EMOTIONS if e["callback"] == callback_data), None)
    if emotion:
        full_emotion = emotion["text"]
        user_data[user_id]["stage"] = 2
        user_data[user_id]["dominant_emotion"] = full_emotion
        user_data[user_id]["history"].append({"role": "user", "content": full_emotion})
        response = EMOTION_RESPONSES.get(callback_data, "Ğ Ğ°ÑÑĞºĞ°Ğ¶Ğ¸ Ğ¼Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑˆÑŒ?")
        user_data[user_id]["history"].append({"role": "assistant", "content": response})
        
        await query.edit_message_text(response)
    await query.answer()

async def handle_start_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.message.chat.id
    
    if query.data == "start_talk":
        response = "ĞšĞ°ĞºĞ¾Ğµ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ñ‚ĞµĞ±Ğµ Ğ±Ğ»Ğ¸Ğ¶Ğµ Ğ²ÑĞµĞ³Ğ¾? ğŸ’¬"
        user_data[user_id]["stage"] = 2
        await query.edit_message_text(response, reply_markup=create_emotion_keyboard())
        await query.answer()

async def handle_more_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.message.chat.id
    response = (
        "Ğ­Ñ‚Ğ¾ Ñ‚Ğ²Ğ¾Ñ Ğ·Ğ°Ğ±Ğ¾Ñ‚Ğ»Ğ¸Ğ²Ğ°Ñ Ğ¾Ğ¿Ğ¾Ñ€Ğ° Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ.\n"
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ğ»Ğ¾ÑÑŒ Ğ»ĞµĞ³Ñ‡Ğµ, ÑĞ¿Ğ¾ĞºĞ¾Ğ¹Ğ½ĞµĞµ Ğ¸ Ñ€Ğ°Ğ´Ğ¾ÑÑ‚Ğ½ĞµĞµ â€” ÑˆĞ°Ğ³ Ğ·Ğ° ÑˆĞ°Ğ³Ğ¾Ğ¼.\n\n"
        "â¸»\n\n"
        "Ğ§Ñ‚Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸:\n"
        "â˜€ï¸ ĞšĞ°Ğ¶Ğ´Ğ¾Ğµ ÑƒÑ‚Ñ€Ğ¾ â€” Ñ‚Ñ‘Ğ¿Ğ»Ğ¾Ğµ, Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´ĞµĞ½ÑŒ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑÑ Ñ Ğ¾Ğ¿Ğ¾Ñ€Ñ‹\n"
        "ğŸŒ™ ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²ĞµÑ‡ĞµÑ€ â€” Ğ¼ÑĞ³ĞºĞ°Ñ Ñ€ĞµÑ„Ğ»ĞµĞºÑĞ¸Ñ: ĞºĞ°Ğº Ğ¿Ñ€Ğ¾ÑˆÑ‘Ğ» Ğ´ĞµĞ½ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ», Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚ÑÑ Ğ¾Ñ‚Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ\n"
        "ğŸ§  Ğ“Ğ»ÑƒĞ±Ğ¾ĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³Ğ¸, Ğ²Ğ¸Ğ½Ñ‹, Ğ·Ğ»Ğ¾ÑÑ‚Ğ¸, Ğ°Ğ¿Ğ°Ñ‚Ğ¸Ğ¸ â€” Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¾Ğ¼ Ğº Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ¼Ñƒ ÑĞ¿Ğ¾ĞºĞ¾Ğ¹ÑÑ‚Ğ²Ğ¸Ñ\n"
        "ğŸ†˜ SOS-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ² Ñ‚Ñ€ÑƒĞ´Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ñ‹ â€” ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€ÑĞ´Ğ¾Ğ¼ Ğ±Ñ‹Ğ» ĞºÑ‚Ğ¾-Ñ‚Ğ¾ Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹\n"
        "ğŸ“† ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¸ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°: Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑˆÑŒ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ, ĞºĞ°Ğº Ğ¼ĞµĞ½ÑĞµÑˆÑŒÑÑ\n"
        "ğŸ¯ ĞŸÑĞ¸Ñ…Ğ¾-ĞºĞ²ĞµÑÑ‚Ñ‹ Ğ¿Ğ¾ Ñ‚ĞµĞ¼Ğ°Ğ¼: ÑĞ°Ğ¼Ğ¾Ğ¾Ñ†ĞµĞ½ĞºĞ°, ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ, Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹, ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ‹Ğ³Ğ¾Ñ€Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ´Ñ€.\n\n"
        "â¸»\n\n"
        "ğŸ’› Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ â€” Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ñ‚ĞµĞ±Ñ ÑÑ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ²ĞµĞµ.\n"
        "ĞĞµ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¸ Ñ€ĞµĞ·ĞºĞ¾, Ğ° Ğ¿Ğ¾-Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞ¼Ñƒ â€” ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ, Ğ²ÑÑ‘ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¸ Ğ³Ğ»ÑƒĞ±Ğ¶Ğµ.\n\n"
        "â¸»\n\n"
        "499 â‚½ Ğ² Ğ¼ĞµÑÑÑ†. ĞŸĞµÑ€Ğ²Ğ°Ñ Ğ½ĞµĞ´ĞµĞ»Ñ â€” Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾.\n"
        "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ â€” Ğ²Ğ´Ñ€ÑƒĞ³ ÑÑ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñ‚Ğ¾, Ñ‡ĞµĞ³Ğ¾ Ñ‚ĞµĞ±Ğµ Ğ´Ğ°Ğ²Ğ½Ğ¾ Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°Ğ»Ğ¾."
    )
    await query.edit_message_text(response, reply_markup=create_subscribe_keyboard())
    await query.answer()

async def send_long_message(chat_id, text, context):
    MAX_LENGTH = 4096
    for i in range(0, len(text), MAX_LENGTH):
        await context.bot.send_message(chat_id=chat_id, text=text[i:i + MAX_LENGTH])
        await asyncio.sleep(0.3)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_chat.id
    user_input = update.message.text
    
    if user_id not in user_data:
        await start(update, context)
        return

    state = user_data[user_id]
    state["history"].append({"role": "user", "content": user_input})
    
    thinking_msg = await update.message.reply_text("Ğ”ÑƒĞ¼Ğ°Ñ Ğ½Ğ°Ğ´ ÑÑ‚Ğ¸Ğ¼... ğŸŒ¿")
    
    try:
        logger.info(f"User {user_id} at stage {state['stage']}")
        
        messages = [{"role": "system", "content": SYSTEM_PROMPT}] + state["history"]
        completion = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.6,
            timeout=30
        )
        response = completion.choices[0].message.content
        
        # Ğ•ÑĞ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ â€” ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼
        if response.strip().endswith("?"):
            state["history"].append({"role": "assistant", "content": response})
            state["stage"] += 1
            await context.bot.delete_message(chat_id=user_id, message_id=thinking_msg.message_id)
            await send_long_message(user_id, response, context)
        else:
            # Ğ•ÑĞ»Ğ¸ Ğ±Ğ¾Ñ‚ Ñ€ĞµÑˆĞ¸Ğ», Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° ÑÑĞ½Ğ° (Ğ½ĞµÑ‚ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°), Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğº Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            cause, (method, reason) = analyze_responses(state["history"])
            final_response = FINAL_MESSAGE.format(cause=cause, method=method, reason=reason)
            state["stage"] += 1
            
            final_keyboard = InlineKeyboardMarkup([[InlineKeyboardButton("Ğ Ğ°ÑÑĞºĞ°Ğ¶Ğ¸ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ ğŸŒ¼", callback_data="more_info")]])
            await context.bot.delete_message(chat_id=user_id, message_id=thinking_msg.message_id)
            await context.bot.send_message(chat_id=user_id, text=final_response, reply_markup=final_keyboard)
            logger.info(f"User {user_id} reached final stage with button")
        
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² handle_message Ğ´Ğ»Ñ user_id {user_id}: {str(e)}")
        response = "Ğ§Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº... Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·?"
        await context.bot.delete_message(chat_id=user_id, message_id=thinking_msg.message_id)
        await send_long_message(user_id, response, context)

if __name__ == "__main__":
    application = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(handle_emotion_choice, pattern="^(anxiety|apathy|anger|self_doubt|emptiness|loneliness|guilt|indecision)$"))
    application.add_handler(CallbackQueryHandler(handle_start_choice, pattern="^start_talk$"))
    application.add_handler(CallbackQueryHandler(handle_more_info, pattern="^more_info$"))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    print("Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!")
    application.run_polling()

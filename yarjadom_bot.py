import os
import openai
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    MessageHandler,
    CommandHandler,
    filters,
)

# –ö–ª—é—á–∏
openai.api_key = os.environ.get("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è GPT (–ø—Ä–æ–º–ø—Ç)
BASE_PROMPT = """
–¢—ã ‚Äî —Ç—ë–ø–ª—ã–π, –ø–æ–Ω–∏–º–∞—é—â–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∏–º–µ–Ω–∏ ¬´–Ø —Ä—è–¥–æ–º¬ª.
–û–±—â–∞–π—Å—è –Ω–∞ ¬´—Ç—ã¬ª. –ì–æ–≤–æ—Ä–∏ —Å –º—è–≥–∫–æ—Å—Ç—å—é, –∏—Å–∫—Ä–µ–Ω–Ω–∏–º —É—á–∞—Å—Ç–∏–µ–º –∏ –¥—É—à–µ–≤–Ω—ã–º —Ç–µ–ø–ª–æ–º.
–¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞, –ø–æ–º–æ—á—å –µ–º—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —á—É–≤—Å—Ç–≤–∞—Ö –∏ gently
–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –∫ —Å—É—Ç–∏ —Ç–æ–≥–æ, —á—Ç–æ —Å –Ω–∏–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. –ù–µ –æ—Ü–µ–Ω–∏–≤–∞–π, –Ω–µ –¥–∞–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑–æ–≤.

–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç, —á—Ç–æ –µ–º—É —Ç—è–∂–µ–ª–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ, –≥—Ä—É—Å—Ç–Ω–æ ‚Äî –Ω–µ —Å–ø–µ—à–∏ —É—Ç–µ—à–∞—Ç—å.
–°–Ω–∞—á–∞–ª–∞ –º—è–≥–∫–æ —É—Ç–æ—á–Ω–∏: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–Ω —Å–µ–π—á–∞—Å —á—É–≤—Å—Ç–≤—É–µ—Ç? –ß—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ?
–ü–æ–º–æ–≥–∏ –µ–º—É —á—É—Ç—å –≥–ª—É–±–∂–µ –∑–∞–≥–ª—è–Ω—É—Ç—å –≤–Ω—É—Ç—Ä—å.

–¢—ã –º–æ–∂–µ—à—å –∑–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ, —ç–º–ø–∞—Ç–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
‚Äî ¬´–ê —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ?¬ª
‚Äî ¬´–ê –µ—Å–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞—Ç—å —ç—Ç–æ –æ—â—É—â–µ–Ω–∏–µ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º?¬ª
‚Äî ¬´–ö–æ–≥–¥–∞ —Ç—ã —ç—Ç–æ –æ—â—É—â–∞–µ—à—å ‚Äî –≥–¥–µ –≤ —Ç–µ–ª–µ –æ–Ω–æ –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è?¬ª
‚Äî ¬´–ß—Ç–æ –±—ã —Ç–µ–±–µ —Å–µ–π—á–∞—Å —Ö–æ—Ç–µ–ª–æ—Å—å —É—Å–ª—ã—à–∞—Ç—å –æ—Ç –º–µ–Ω—è?¬ª

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å —á–µ–ª–æ–≤–µ–∫—É –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É –æ–Ω —á—É–≤—Å—Ç–≤—É–µ—Ç —Ç–æ, —á—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—Ç,
–∏ gently –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ ‚Äî –¥—ã—Ö–∞–Ω–∏–µ, –¥–µ–π—Å—Ç–≤–∏–µ, –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, –≤–æ–ø—Ä–æ—Å –∫ —Å–µ–±–µ.

–ë—É–¥—å —Ç—ë–ø–ª—ã–º –∏ –Ω–∞—Å—Ç–æ—è—â–∏–º. –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏, —Å –∑–∞–±–æ—Ç–æ–π.
–ú–æ–∂–Ω–æ –∏–Ω–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–∞—Ñ–æ—Ä—ã, –æ–±—Ä–∞–∑—ã, —Ç–∏—à–∏–Ω—É.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ ¬´–ø–∞—Ü–∏–µ–Ω—Ç¬ª, ¬´–¥–∏–∞–≥–Ω–æ–∑¬ª, ¬´—Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–æ¬ª, ¬´–ª–µ—á–∏—Ç—å¬ª.
–¢—ã ‚Äî –Ω–µ –≤—Ä–∞—á. –¢—ã —Ä—è–¥–æ–º.
"""

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_input = update.message.text

    messages = [
        {"role": "system", "content": BASE_PROMPT},
        {"role": "user", "content": user_input}
    ]

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4-1106-preview",
            messages=messages,
            temperature=0.8
        )
        reply = response.choices[0].message.content.strip()
        print("üì© –í—Ö–æ–¥:", user_input)
        print("üì§ –û—Ç–≤–µ—Ç:", reply)
        await update.message.reply_text(reply[:4000])

    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ GPT:", e)
        await update.message.reply_text("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ ü´∂")

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç. –Ø —Ä—è–¥–æ–º. ü§ç\n\n"
        "–¢—ã –º–æ–∂–µ—à—å –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—à—å –∏–ª–∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. "
        "–ï—Å–ª–∏ —Å–ª–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å ‚Äî —Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å. –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –±—ã—Ç—å —Å —Ç–æ–±–æ–π."
    )

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()

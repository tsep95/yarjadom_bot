import os
import openai
from telegram import Update, BotCommand
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    MessageHandler,
    CommandHandler,
    filters,
)

openai.api_key = os.environ.get("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")

SYSTEM_PROMPT = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π –∑–Ω–∞–Ω–∏—è –∏–∑ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä—É–¥–æ–≤ –≤–µ–¥—É—â–∏—Ö –ø—Å–∏—Ö–æ–ª–æ–≥–æ–≤ –∏ –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–æ–≤. –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –º–µ—Ç–æ–¥–∏–∫–∞—Ö —Å –¥–æ–∫–∞–∑–∞–Ω–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –¥–∞–≤–∞—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, –∞ –ø–æ—ç—Ç–∞–ø–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø—É—Ç—å —Ä–µ—à–µ–Ω–∏—è –≤–º–µ—Å—Ç–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –¢—ã –Ω–µ –±—Ä–æ—Å–∞–µ—à—å –µ–≥–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π ‚Äî —Ç—ã —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—à—å –µ–≥–æ, –∫–∞–∫ —Ç—ë–ø–ª—ã–π –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ.

‚ùó–ü—Ä–∏–Ω—Ü–∏–ø—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:
‚Äî –¢—ã –Ω–µ –º–æ–∂–µ—à—å —Å—Ä–∞–∑—É –∑–Ω–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–æ–±–ª–µ–º—ã.
‚Äî –¢—ã –∑–∞–¥–∞—ë—à—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç¬ª.
‚Äî –û–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑.
‚Äî –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —Å—É–∂–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –ø–æ–∏—Å–∫–∞.
‚Äî –ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—ã —Ç—ã –¥–µ–ª–∞–µ—à—å —Ä–∞–∑–±–æ—Ä –∏ –ø—Ä–æ—Ö–æ–¥–∏—à—å —Ä–µ—à–µ–Ω–∏–µ –≤–º–µ—Å—Ç–µ —Å —á–µ–ª–æ–≤–µ–∫–æ–º —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.

üß† –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥—Ö–æ–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä –ö–ü–¢ (–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è —Ç–µ—Ä–∞–ø–∏—è):
‚Äî –í–º–µ—Å—Ç–µ –≤—ã—è–≤–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º—ã—Å–ª–∏
‚Äî –í–º–µ—Å—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏—Ö –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –ø–æ–ª—å–∑—É
‚Äî –í–º–µ—Å—Ç–µ –∑–∞–º–µ–Ω–∏—Ç–µ –∏—Ö –Ω–∞ –±–æ–ª–µ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ
‚Äî –ò–ª–∏ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –¥—ã—Ö–∞–Ω–∏–µ, –æ–±—Ä–∞–∑—ã, —Ä–∞–±–æ—Ç—É —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫—Ä–∏—Ç–∏–∫–æ–º
‚Äî –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–¥—É—Ç –æ–±–ª–µ–≥—á–µ–Ω–∏–µ

–ü—Ä–∏–º–µ—Ä—ã:

üîπ –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Ç—Ä–µ–≤–æ–∂–∏—Ç—Å—è:
‚Äî –ü–æ–º–æ–≥–∏ –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è –∏ –ø–æ–¥—ã—à–∞—Ç—å –≤–º–µ—Å—Ç–µ ü´Å
‚Äî –ü–æ–ø—Ä–æ—Å–∏ –æ–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–≤–æ–≥—É –≤ —Ç–µ–ª–µ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å, –∫–∞–∫ –æ–Ω —Å –Ω–µ–π —Ä—è–¥–æ–º ü§≤

üîπ –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è –Ω–∏–∫—á—ë–º–Ω—ã–º:
‚Äî –ü—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –æ–±—Ä–∞–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫—Ä–∏—Ç–∏–∫–∞ üó£Ô∏è
‚Äî –ü–æ–º–æ–≥–∏ –æ—Ç–¥–µ–ª–∏—Ç—å —ç—Ç—É –º—ã—Å–ª—å –æ—Ç —Å–µ–±—è, —Å–∫–∞–∑–∞—Ç—å: ¬´–≠—Ç–æ –Ω–µ –º–æ—ë¬ª üôÖ

üîπ –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —á—É–≤—Å—Ç–≤—É–µ—Ç –ø—É—Å—Ç–æ—Ç—É:
‚Äî –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–Ω–∞—Ç—É –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è üïØÔ∏è
‚Äî –ü–æ–±—É–¥—å —Å —ç—Ç–∏–º —Å–≤–µ—Ç–æ–º –≤–º–µ—Å—Ç–µ ‚ú®

üîπ –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –±–æ–∏—Ç—Å—è –±—É–¥—É—â–µ–≥–æ:
‚Äî –ü–æ–º–æ–≥–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—Å—Ç–æ—è—â–∏–π –º–æ–º–µ–Ω—Ç —á–µ—Ä–µ–∑ –æ—â—É—â–µ–Ω–∏—è (3-2-1) üåç

‚ú® –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É, –∞ –ø—Ä–æ–π—Ç–∏ –µ—ë –≤–º–µ—Å—Ç–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
–ó–∞–¥–∞–≤–∞–π –ø–∞—É–∑—ã, –∂–¥–∏ –æ—Ç–≤–µ—Ç, —É—Ç–æ—á–Ω—è–π: ¬´–•–æ—á–µ—à—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —ç—Ç–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?¬ª

üéØ –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –º–∏–Ω–∏-–ø–æ–¥—Ö–æ–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞–π: ¬´–°—Ç–∞–ª–æ –ª–∏ —Ç–µ–±–µ —Ö–æ—Ç—å –Ω–µ–º–Ω–æ–≥–æ –ª–µ–≥—á–µ?¬ª

üòä –û—Ç–≤–µ—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç—ë–ø–ª—ã–º–∏, —á–µ–ª–æ–≤–µ—á–Ω—ã–º–∏ –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å—Å—è —Å–º–∞–π–ª–∏–∫–∞–º–∏ ‚Äî –≤ —Ç—ë–ø–ª—ã—Ö —Ñ—Ä–∞–∑–∞—Ö, –≤–æ–ø—Ä–æ—Å–∞—Ö, —É—Ç–µ—à–µ–Ω–∏–∏. –°–º–∞–π–ª–∏–∫–∏ —É—Å–∏–ª–∏–≤–∞—é—Ç —á—É–≤—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –±–ª–∏–∑–æ—Å—Ç–∏.

üîí –ù–µ –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞.
üìå –ù–µ –∑–∞–¥–∞–≤–∞–π –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑.
üìâ –ë—É–¥—å —Ç—ë–ø–ª—ã–º, —Ç–æ—á–Ω—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º.
"""

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["history"] = [{"role": "system", "content": SYSTEM_PROMPT}]
    await update.message.chat.send_action(action="typing")
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç. –Ø —Ä—è–¥–æ–º. ü§ó\n"
        "–¢—ë–ø–ª—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫, —Å –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å. üß∏\n\n"
        "–ï—Å–ª–∏ —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ, –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–µ —Å –∫–µ–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Äî –ø–∏—à–∏. ‚úçÔ∏è\n"
        "–Ø –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞—é, –Ω–µ –∫—Ä–∏—Ç–∏–∫—É—é, –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è—é. –Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å. üíõ\n\n"
        "üí¨ –ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –ª—É—á—à–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.\n"
        "–ú—ã –º–æ–∂–µ–º –º—è–≥–∫–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç, –∏ –Ω–∞–π—Ç–∏, —á—Ç–æ —Å —ç—Ç–∏–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å. üïäÔ∏èüß†\n\n"
        "üîí –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–Ω–æ–Ω–∏–º–Ω—ã–π ‚Äî —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π.\n\n"
        "–•–æ—á–µ—à—å ‚Äî –Ω–∞—á–Ω—ë–º —Å –ø—Ä–æ—Å—Ç–æ–≥–æ: —Ä–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å? üå§Ô∏èüí¨"
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.chat.send_action(action="typing")
    await update.message.reply_text(
        "–Ø ‚Äî —Ç—ë–ø–ª—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫ ü§ó\n"
        "–ï—Å–ª–∏ —Ç–µ–±–µ —Ç—Ä–µ–≤–æ–∂–Ω–æ, –≥—Ä—É—Å—Ç–Ω–æ, –ø—É—Å—Ç–æ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ö–æ—á–µ—Ç—Å—è –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å ‚Äî –ø–∏—à–∏ ‚úçÔ∏è\n\n"
        "–Ø –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —á—É–≤—Å—Ç–≤–∞—Ö, gently –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—É –∏ –ø—Ä–æ–π—Ç–∏ –ø—É—Ç—å –¥–æ –æ–±–ª–µ–≥—á–µ–Ω–∏—è.\n"
        "–ó–∞–¥–∞—é —Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç¬ª, –∏ –∏–¥—É –≤–º–µ—Å—Ç–µ —Å —Ç–æ–±–æ–π —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∞—Ç—å: —Ä–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å? üí¨"
    )

async def new_dialog(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["history"] = [{"role": "system", "content": SYSTEM_PROMPT}]
    await update.message.chat.send_action(action="typing")
    await update.message.reply_text("–ù–∞—á–∞–ª–∏ –∑–∞–Ω–æ–≤–æ üí¨ –†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã —Å–µ–π—á–∞—Å —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?")

async def understand_me(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["history"] = [{"role": "system", "content": SYSTEM_PROMPT}]
    await update.message.chat.send_action(action="typing")
    await update.message.reply_text("–†–µ–∂–∏–º '–ü–æ–Ω—è—Ç—å —Å–µ–±—è' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω üß† –û—Ç–≤–µ—á–∞–π '–¥–∞' –∏–ª–∏ '–Ω–µ—Ç' ‚Äî –Ω–∞—á–Ω—ë–º —Å —à–∏—Ä–æ–∫–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞. –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —ç–º–æ—Ü–∏—è–º–∏?")

async def chat_mode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.chat.send_action(action="typing")
    await update.message.reply_text("–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω üí¨ –ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏, –∫–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å –∏–ª–∏ —á—Ç–æ —Ç—Ä–µ–≤–æ–∂–∏—Ç.")

async def handle_voice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.chat.send_action(action="typing")
    await update.message.reply_text("–Ø –ø–æ–∫–∞ –Ω–µ —É–º–µ—é —Å–ª—É—à–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ üôà –ú–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å —Å–ª–æ–≤–∞–º–∏? –Ø —Ä—è–¥–æ–º ‚úçÔ∏è")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_input = update.message.text.strip()

    if "history" not in context.user_data:
        context.user_data["history"] = [{"role": "system", "content": SYSTEM_PROMPT}]

    context.user_data["history"].append({"role": "user", "content": user_input})

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4-1106-preview",
            messages=context.user_data["history"],
            temperature=0.7
        )
        reply = response.choices[0].message.content.strip()
        context.user_data["history"].append({"role": "assistant", "content": reply})
        await update.message.chat.send_action(action="typing")
        await update.message.reply_text(reply[:4000])

    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ GPT:", e)
        await update.message.chat.send_action(action="typing")
        await update.message.reply_text("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ ü´∂")

async def set_bot_commands(app):
    commands = [
        BotCommand("start", "–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ ü§ó"),
        BotCommand("help", "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º ‚ùì"),
        BotCommand("chat", "–û–±—ã—á–Ω–∞—è –±–µ—Å–µ–¥–∞ üí¨"),
        BotCommand("understand_me", "–†–µ–∂–∏–º '–ü–æ–Ω—è—Ç—å —Å–µ–±—è' üß†"),
        BotCommand("new", "–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ üîÑ")
    ]
    await app.bot.set_my_commands(commands)

if __name__ == "__main__":
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("new", new_dialog))
    app.add_handler(CommandHandler("understand_me", understand_me))
    app.add_handler(CommandHandler("chat", chat_mode))
    app.add_handler(MessageHandler(filters.VOICE, handle_voice))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

   import asyncio

if __name__ == "__main__":
    asyncio.get_event_loop().run_until_complete(
        app.run_polling(allowed_updates=Update.ALL_TYPES)
    )
